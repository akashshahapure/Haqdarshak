<html lang="en" style="height: auto; min-height: 100%;">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="/static/main.css">
    <title>Sampling Portal</title>
</head>
<body>
    <header>
        <span class="header-content">
            <a href="/homepage/"><h1>Haqdarshak</h1></a>
            <h2>Data Sampling Portal for M&E Team</h2>
        </span>
    </header>

    <main>
        <div class="form-container">
            <form id="data-sampling-form" action="/homepage/" method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="form-group">
                    <label for="name">Enter Your Name:</label>
                    <input type="text" id="name" name="name" placeholder="Enter your name here" required>
                </div>

                <div class="form-group">
                    <label for="email">Enter your Haqdarshak email ID:</label>
                    <input type="email" id="email" name="email" placeholder="abc.def@haqdarshak.com" required>
                </div>

                <div class="form-group">
                    <label for="file-upload">Select the raw data file for sampling:</label>
                    <input type="file" id="file-upload" name="file" accept=".csv,.xlsx,.xls" required>
                </div>

                <div class="form-group">
                    <label for="sample-percent">Provide the percent to sample the data (10-90):</label>
                    <input type="number" id="sample-percent" name="percent" min="10" max="90" required>
                </div>

                <div class="button-group">
                    <button type="submit">Sample the Data</button>
                    <button type="reset">Reset</button>
                </div>
            </form>
        </div>
    </main>

    <div id="messageBox" style="display: none; text-align: center; font-size: 1.2rem; padding: 20px; background: #f2dede; border: 1px solid #ebccd1; color: #a94442; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000;">
        Sampling the data. Please wait...
    </div>

    <script>
        document.getElementById("data-sampling-form").addEventListener("submit", function (event) {
            event.preventDefault();

            const messageBox = document.getElementById("messageBox");
            messageBox.style.display = "block";
            messageBox.textContent = "Sampling the data. Please wait...";

            const formData = new FormData(this);

            fetch("/homepage/", {
                method: "POST",
                body: formData,
            })
            .then((response) => {
                if (response.status === 409) {
                    messageBox.textContent = "Please provide correct format of the data";
                    setTimeout(() => {
                        messageBox.style.display = "none";
                        document.getElementById("data-sampling-form").reset();
                    }, 3000);
                } else if (response.ok) {
                    // Get the filename from the Content-Disposition header
                    const disposition = response.headers.get("Content-Disposition");
                    const filename = disposition ? disposition.split("filename=")[1].replace(/"/g, "") : "sampled_data.xlsx";

                    response.blob().then((blob) => {
                        const downloadUrl = window.URL.createObjectURL(blob);
                        const downloadLink = document.createElement("a");
                        downloadLink.href = downloadUrl;
                        downloadLink.style.display = "none";
                        downloadLink.download = filename;
                        document.body.appendChild(downloadLink);
                        downloadLink.click();
                        window.URL.revokeObjectURL(downloadUrl);

                        messageBox.textContent = "Sampled data downloaded successfully!";
                        setTimeout(() => {
                            messageBox.style.display = "none";
                            document.getElementById("data-sampling-form").reset();
                        }, 2000);
                    });
                } else {
                    return Promise.reject(response);
                }
            })
            .catch((error) => {
                messageBox.textContent = "An error occurred while processing the data. Please try again.";
                setTimeout(() => {
                    messageBox.style.display = "none";
                    document.getElementById("data-sampling-form").reset();
                }, 3000);
            });
        });
    </script>
</body>
</html>
